<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç‘„ç‘„å’Œç¡•ç¡•çš„ä¸–ç•Œ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary-color:#ff6b81;
      --bg-color:#1a1a2e;
      --text-color:#e0e0e0;
    }
    body, html{
      margin:0; padding:0; height:100%;
      font-family:'Noto Serif SC', serif;
      background-color:var(--bg-color);
      color:var(--text-color);
      overflow-x:hidden;
    }

    /* ç™»å½•å±‚ */
    #login-overlay{
      position:fixed; inset:0;
      background:linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('photo1.jpg') no-repeat center/cover;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      z-index:9999;
      transition:opacity 0.8s ease-out;
    }
    #login-overlay h1{
      font-family:'Dancing Script', cursive;
      font-size:3.2em;
      color:var(--primary-color);
      text-shadow:2px 2px 4px rgba(0,0,0,0.5);
      margin-bottom:30px;
      cursor:pointer;
      text-align:center;
      padding:0 20px;
    }
    .login-box{
      background:rgba(255,255,255,0.1);
      backdrop-filter:blur(10px);
      padding:30px;
      border-radius:15px;
      text-align:center;
      display:none;
    }
    .login-box input{
      padding:10px;
      font-size:16px;
      border:2px solid var(--primary-color);
      border-radius:6px;
      background:rgba(255,255,255,0.9);
      outline:none;
    }
    .login-box button{
      margin-top:15px;
      padding:10px 26px;
      font-size:18px;
      background-color:var(--primary-color);
      color:white;
      border:none;
      border-radius:999px;
      cursor:pointer;
    }
    #error-msg{ color:#ff6b6b; display:none; margin-top:10px; }

    /* ä¸»å†…å®¹ */
    #main-content{
      display:none;
      opacity:0;
      transition:opacity 1s ease-in;
      padding-bottom:50px;
    }
    section{
      min-height:80vh;
      padding:40px 20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    h2.section-title{
      font-family:'Dancing Script', cursive;
      font-size:3em;
      color:var(--primary-color);
      margin-bottom:40px;
    }

    /* çˆ±å¿ƒç…§ç‰‡å¢™ */
    #gallery-section{
      background:#1a1a2e;
      position:relative;
      overflow:hidden;
      min-height:900px;
    }
    .heart-stage{
      position:relative;
      width:min(980px, 95vw);
      height:min(720px, 78vh);
      margin:0 auto;
      border-radius:24px;
      box-shadow:0 0 70px rgba(255,107,129,0.08);
    }
    .heart-stage::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,107,129,0.10), transparent 45%),
        radial-gradient(circle at 70% 40%, rgba(255,107,129,0.08), transparent 50%),
        radial-gradient(circle at 50% 70%, rgba(255,255,255,0.04), transparent 55%);
      pointer-events:none;
      border-radius:24px;
    }
    .heart-item{
      position:absolute;
      width:120px; height:86px;
      border-radius:14px;
      overflow:hidden;
      border:3px solid rgba(255,255,255,0.95);
      box-shadow:0 18px 40px rgba(0,0,0,0.55);
      background:#000;
      cursor:pointer;
      transform:translate(-50%, -50%) rotate(var(--r, 0deg));
      transition:transform 0.25s ease, box-shadow 0.25s ease, filter 0.25s ease;
      will-change:transform;
    }
    .heart-item img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .heart-item:hover{
      transform:translate(-50%, -50%) rotate(var(--r, 0deg)) scale(1.06);
      box-shadow:0 24px 60px rgba(0,0,0,0.65);
      filter:brightness(1.05);
      z-index:10;
    }

    /* Lightbox */
    .lightbox{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.72);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9998;
      padding:20px;
    }
    .lightbox.show{ display:flex; }
    .lightbox-card{
      width:min(920px, 92vw);
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.18);
      backdrop-filter:blur(10px);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 30px 90px rgba(0,0,0,0.6);
      position:relative;
    }
    .lightbox-imgwrap{
      width:100%;
      aspect-ratio: 16/10;
      background:#000;
      display:flex; align-items:center; justify-content:center;
    }
    .lightbox-imgwrap img{
      width:100%; height:100%;
      object-fit:contain;
      display:block;
      background:#000;
    }
    .lightbox-bar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      color:#ddd;
      font-size:14px;
    }
    .lightbox-btn{
      background:rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.18);
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .lightbox-close{
      position:absolute;
      top:10px; right:10px;
      width:38px; height:38px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      background:rgba(0,0,0,0.35);
      border:1px solid rgba(255,255,255,0.15);
      cursor:pointer;
      color:#fff;
      font-size:20px;
      z-index:2;
    }

    /* åœ°å›¾ */
    #map{
      width:95%;
      max-width:1000px;
      height:500px;
      border-radius:15px;
      border:3px solid var(--primary-color);
    }

    #timer{ font-size:1.8em; line-height:1.5; }
    .timer-digit{ color:var(--primary-color); font-weight:bold; }

    @media (max-width: 520px){
      .heart-item{ width:92px; height:66px; border-width:2px; }
      #login-overlay h1{ font-size:2.6em; }
    }

    /* âœ… éŸ³ä¹æŒ‰é’®ï¼ˆå…¨ç«¯å¯ç”¨ï¼‰ */
    .music-fab{
      position:fixed;
      top:14px;
      right:14px;
      z-index:10000;
      background:rgba(0,0,0,0.45);
      border:1px solid rgba(255,255,255,0.18);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      backdrop-filter:blur(10px);
      cursor:pointer;
      user-select:none;
      display:none; /* ç™»å½•åæ˜¾ç¤º */
      font-size:14px;
    }

    /* âœ… Safari å¤±è´¥æ—¶çš„æç¤ºæ¡ */
    .music-toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      z-index:10000;
      background:rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,0.18);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      backdrop-filter:blur(10px);
      font-size:14px;
      cursor:pointer;
      user-select:none;
      display:none;
      max-width:92vw;
      text-align:center;
    }
  </style>
</head>

<body>
  <!-- âœ… åŠ  preload / playsinline æ›´ç¨³ -->
  <audio id="bg-music" loop preload="auto" playsinline>
    <source src="bgm.mp3" type="audio/mpeg">
  </audio>

  <div id="login-overlay">
    <h1 id="enter-btn">ç‚¹å‡»è¿›å…¥ ç‘„ç‘„å’Œç¡•ç¡•çš„ä¸–ç•Œ</h1>
    <div class="login-box" id="login-input-area">
      <p>è¯·è¾“å…¥è§£é”å¯†ç  (æˆ‘ä»¬çš„çºªå¿µæ—¥)</p>
      <input type="date" id="password-input">
      <br>
      <button id="unlock-btn" type="button">è§£é”</button>
      <p id="error-msg">æ—¥æœŸä¸å¯¹å“¦ï¼Œå†æƒ³æƒ³ï¼Ÿ</p>
    </div>
  </div>

  <!-- âœ… éŸ³ä¹å¼€å…³ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
  <div class="music-fab" id="music-fab">ğŸµ æ’­æ”¾</div>
  <div class="music-toast" id="music-toast">ğŸµ Safari éœ€è¦å†ç‚¹ä¸€ä¸‹æ‰èƒ½æ’­æ”¾éŸ³ä¹ï¼ˆç‚¹æˆ‘æ’­æ”¾ï¼‰</div>

  <div id="main-content">
    <section id="timer-section">
      <h2 class="section-title">æˆ‘ä»¬å·²ç»ç›¸çˆ±äº†</h2>
      <div id="timer">æ­£åœ¨è®¡ç®—æ—¶é—´...</div>
    </section>

    <section id="gallery-section">
      <h2 class="section-title">çˆ±çš„ç‚¹ç‚¹æ»´æ»´</h2>
      <div class="heart-stage" id="heart-stage"></div>
      <p style="margin-top:16px; color:#888;">ï¼ˆç‚¹å‡»ä»»æ„ç…§ç‰‡å¯æ”¾å¤§æŸ¥çœ‹ï¼›é”®ç›˜ â† â†’ å¯åˆ‡æ¢ï¼‰</p>
    </section>

    <section id="map-section">
      <h2 class="section-title">æˆ‘ä»¬ä¸€èµ·å»è¿‡çš„åœ°æ–¹</h2>
      <div id="map"></div>
    </section>
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox">
    <div class="lightbox-card">
      <div class="lightbox-close" id="lightbox-close">Ã—</div>
      <div class="lightbox-imgwrap">
        <img id="lightbox-img" alt="memory">
      </div>
      <div class="lightbox-bar">
        <div id="lightbox-title">1 / 30</div>
        <div style="display:flex; gap:10px;">
          <div class="lightbox-btn" id="prev-btn">ä¸Šä¸€å¼ </div>
          <div class="lightbox-btn" id="next-btn">ä¸‹ä¸€å¼ </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ============ é…ç½® =============
    const correctPassword = "2021-05-26";
    const startDate = new Date("2021-05-26T16:00:00");
    const PHOTO_TOTAL = 30; // photo1.jpg ~ photo30.jpg

    const mapPoints = [
      [53.3498, -6.2603, "éƒ½æŸæ—", "æˆ‘ä»¬ç›¸é‡çš„åœ°æ–¹ â˜˜ï¸"],
      [48.8566, 2.3522, "å·´é»", "ä¸€èµ·å»çœ‹å‘¨æ°ä¼¦"],
      [29.0469, -13.5899, "å…°è¨ç½—ç‰¹", "ç¬¬ä¸€æ¬¡æ—…æ¸¸"],
      [51.5074, -0.1278, "ä¼¦æ•¦", "ç‰¹ç§å…µèˆ¬çš„å¬äº†æ—ä¿Šæ°"],
      [53.4084, -2.9916, "åˆ©ç‰©æµ¦", "æ”¾ç©ºè„‘è¢‹è¢«ä½ å®‰æ’çš„ä¸€å¤©"],
      [36.7213, -4.4214, "é©¬æ‹‰åŠ ", "æ™’äº†ä¸€å‘¨çš„å¤ªé˜³"],
      [28.2916, -16.6291, "ç‰¹å†…é‡Œè´¹", "ä¸ä¼šå¿˜è®°çš„äº‘æµ·å’Œæ¼«å¤©æ˜Ÿæ˜Ÿ"],
      [52.3676, 4.9041, "é˜¿å§†æ–¯ç‰¹ä¸¹", "éš¾å¿˜çš„ç”Ÿæ—¥"],
      [25.7209, 119.3758, "ç¦æ¸…", "æˆ‘çš„å®¶ä¹¡"],
      [41.8057, 123.4315, "æ²ˆé˜³", "ä½ çš„å®¶ä¹¡"],
      [39.9042, 116.4074, "åŒ—äº¬", "æ°¸è¿œä¸ä¼šå¿˜è®°äº¤æ¢åŠå¹´çš„å¿«ä¹"],
      [39.0841, 117.2009, "å¤©æ´¥", "ç…é¥¼æœå­å˜»å˜»"],
      [34.3416, 108.9398, "è¥¿å®‰", "ç©¿è¶Šå›äº†å¤ä»£"],
      [36.0671, 120.3826, "é’å²›", "æˆ‘çˆ±æµ·é²œä½ çˆ±é…’"],
      [24.4798, 118.0894, "å¦é—¨", "ç¾ä¸½çš„é¼“æµªå±¿"],
      [25.5037, 119.7912, "å¹³æ½­", "å¯»æ‰¾è“çœ¼æ³ªå¤±è´¥"],
      [25.6065, 100.2676, "å¤§ç†", "å¿˜ä¸æ‰æ²¡æœ‰ä¹Œäº‘çš„è“å¤©"],
      [25.0406, 102.7122, "æ˜†æ˜", "æ²¡åƒåˆ°ç”Ÿçš„è§æ‰‹é’"]
    ];

    // ============ DOM =============
    const enterBtn = document.getElementById('enter-btn');
    const loginBox = document.getElementById('login-input-area');
    const unlockBtn = document.getElementById('unlock-btn');
    const errorMsg = document.getElementById('error-msg');

    const audio = document.getElementById('bg-music');
    const musicFab = document.getElementById('music-fab');
    const musicToast = document.getElementById('music-toast');

    let musicReady = false;

    // è¿›å…¥æŒ‰é’®
    enterBtn.addEventListener('click', () => {
      enterBtn.style.display = 'none';
      loginBox.style.display = 'block';
    });

    // âœ… éŸ³ä¹UIæ›´æ–°
    function syncMusicUI(){
      if(!musicReady){
        musicFab.textContent = "ğŸµ æ’­æ”¾";
        return;
      }
      musicFab.textContent = audio.paused ? "ğŸµ æ’­æ”¾" : "â¸ æš‚åœ";
    }

    // âœ… å°è¯•æ’­æ”¾ï¼ˆSafari/æ‰‹æœºå¤±è´¥å°±å¼¹ toastï¼‰
    async function tryPlayFromUserGesture(){
      // ä¸€äº› Safari éœ€è¦å…ˆ load
      try { audio.load(); } catch(e){}

      try{
        await audio.play();
        musicReady = true;
        musicToast.style.display = 'none';
        musicFab.style.display = 'block';
        syncMusicUI();
        return true;
      }catch(err){
        // è¢«æ‹¦æˆª / ä¸æ”¯æŒ / é™éŸ³é”®ç­‰
        musicReady = true;               // ä»ç„¶å…è®¸ç”¨æˆ·ç”¨æŒ‰é’®æ§åˆ¶
        musicFab.style.display = 'block';
        musicToast.style.display = 'block';
        syncMusicUI();
        return false;
      }
    }

    // âœ… å³ä¸Šè§’æŒ‰é’®ï¼šéšæ—¶åˆ‡æ¢
    musicFab.addEventListener('click', async () => {
      try{
        if(audio.paused){
          await audio.play();
        }else{
          audio.pause();
        }
      }catch(e){
        // å¦‚æœ Safari è¿˜æ‹¦ï¼Œç»§ç»­æ˜¾ç¤º toast å¼•å¯¼
        musicToast.style.display = 'block';
      }
      syncMusicUI();
    });

    // âœ… toast ç‚¹ä¸€ä¸‹æ’­æ”¾ï¼ˆæ‰‹æœºæœ€ç¨³ï¼‰
    musicToast.addEventListener('click', async () => {
      await tryPlayFromUserGesture();
      syncMusicUI();
    });

    // è§£é”æŒ‰é’®
    unlockBtn.addEventListener('click', async () => {
      const inputDate = document.getElementById('password-input').value;

      if(inputDate !== correctPassword){
        errorMsg.style.display = 'block';
        return;
      }
      errorMsg.style.display = 'none';

      // âœ… å…³é”®ï¼šåœ¨â€œç”¨æˆ·ç‚¹å‡»è§£é”â€è¿™ä¸ªæ‰‹åŠ¿é‡Œç«‹åˆ»æ’­æ”¾
      await tryPlayFromUserGesture();

      // è¿‡æ¸¡åŠ¨ç”»
      document.getElementById('login-overlay').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        setTimeout(() => { document.getElementById('main-content').style.opacity = '1'; }, 50);

        initTimer();
        initHeartGallery();
        initMap();
      }, 800);
    });

    // ===== è®¡æ—¶å™¨ =====
    function initTimer(){
      setInterval(() => {
        const diff = new Date() - startDate;
        const d = Math.floor(diff / 86400000);
        const h = Math.floor((diff / 3600000) % 24);
        const m = Math.floor((diff / 60000) % 60);
        const s = Math.floor((diff / 1000) % 60);
        document.getElementById('timer').innerHTML =
          `<span class="timer-digit">${d}</span> å¤© <span class="timer-digit">${h}</span> å°æ—¶ <span class="timer-digit">${m}</span> åˆ† <span class="timer-digit">${s}</span> ç§’`;
      }, 1000);
    }

    // ===== çˆ±å¿ƒç…§ç‰‡å¢™ =====
    function initHeartGallery(){
      const stage = document.getElementById('heart-stage');
      stage.innerHTML = "";

      const lightbox = document.getElementById('lightbox');
      const lightboxImg = document.getElementById('lightbox-img');
      const lightboxTitle = document.getElementById('lightbox-title');
      const closeBtn = document.getElementById('lightbox-close');
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');

      let currentIndex = 1;

      function openAt(index){
        currentIndex = index;
        lightboxImg.src = `photo${index}.jpg`;
        lightboxImg.onerror = () => { lightbox.classList.remove('show'); };
        lightboxTitle.textContent = `${index} / ${PHOTO_TOTAL}`;
        lightbox.classList.add('show');
      }
      function close(){ lightbox.classList.remove('show'); }
      function prev(){ openAt(currentIndex - 1 < 1 ? PHOTO_TOTAL : currentIndex - 1); }
      function next(){ openAt(currentIndex + 1 > PHOTO_TOTAL ? 1 : currentIndex + 1); }

      closeBtn.onclick = close;
      prevBtn.onclick = (e) => { e.stopPropagation(); prev(); };
      nextBtn.onclick = (e) => { e.stopPropagation(); next(); };
      lightbox.onclick = (e) => { if(e.target === lightbox) close(); };

      document.onkeydown = (e) => {
        if(!lightbox.classList.contains('show')) return;
        if(e.key === 'Escape') close();
        if(e.key === 'ArrowLeft') prev();
        if(e.key === 'ArrowRight') next();
      };

      const W = stage.clientWidth;
      const H = stage.clientHeight;
      const scale = Math.min(W, H) / 40;
      const cx = W / 2;
      const cy = H / 2 + 10;

      const outerCount = Math.round(PHOTO_TOTAL * 0.6);
      const innerCount = PHOTO_TOTAL - outerCount;
      const points = [];

      function heartPoint(t){
        const x = 16 * Math.pow(Math.sin(t), 3);
        const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
        return { x, y };
      }

      for(let i = 0; i < outerCount; i++){
        const t = (i / outerCount) * Math.PI * 2;
        const p = heartPoint(t);
        points.push({ x: cx + p.x * scale, y: cy - p.y * scale });
      }

      const innerScale = scale * 0.72;
      for(let i = 0; i < innerCount; i++){
        const t = (i / innerCount) * Math.PI * 2 + (Math.PI / innerCount);
        const p = heartPoint(t);
        const jitterX = (Math.random() - 0.5) * 18;
        const jitterY = (Math.random() - 0.5) * 14;
        points.push({ x: cx + p.x * innerScale + jitterX, y: cy - p.y * innerScale + jitterY });
      }

      for(let i = 1; i <= PHOTO_TOTAL; i++){
        const item = document.createElement('div');
        item.className = 'heart-item';

        const p = points[i - 1];
        item.style.left = `${p.x}px`;
        item.style.top = `${p.y}px`;

        const rot = (Math.random() * 10 - 5).toFixed(2);
        item.style.setProperty('--r', `${rot}deg`);

        const img = document.createElement('img');
        img.loading = "lazy";
        img.decoding = "async";
        img.src = `photo${i}.jpg`;
        img.onerror = () => item.remove();

        item.onclick = (e) => { e.stopPropagation(); openAt(i); };

        item.appendChild(img);
        stage.appendChild(item);
      }

      // é˜²æŠ–é‡æ’
      window.addEventListener('resize', () => {
        clearTimeout(window.__heartResizeTimer);
        window.__heartResizeTimer = setTimeout(() => initHeartGallery(), 250);
      }, { once:false });
    }

    // ===== åœ°å›¾ï¼šç”µè„‘ hoverï¼Œæ‰‹æœº tap =====
    function initMap(){
      const map = L.map('map').setView([40, 60], 3);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      const heartIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/833/833472.png',
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30]
      });

      const bounds = [];
      const markers = [];

      mapPoints.forEach(p => {
        const latlng = [p[0], p[1]];
        bounds.push(latlng);

        const marker = L.marker(latlng, { icon: heartIcon }).addTo(map);
        markers.push(marker);

        marker.bindPopup(
          `<b style="color:#ff6b81">${p[2]}</b><br>${p[3]}`,
          { closeButton:false, autoClose:true, closeOnClick:false, offset:L.point(0,-10) }
        );

        // ç”µè„‘ï¼šhover
        marker.on('mouseover', function(){ this.openPopup(); });
        marker.on('mouseout', function(){ this.closePopup(); });

        // æ‰‹æœºï¼šç‚¹ä¸€ä¸‹æ‰“å¼€ï¼ˆæ—  hoverï¼‰
        marker.on('click', function(){
          markers.forEach(m => { if(m !== this) m.closePopup(); });
          this.openPopup();
        });
      });

      if(bounds.length) map.fitBounds(bounds, { padding: [30, 30] });
    }
  </script>
</body>
</html>
